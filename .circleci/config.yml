version: 2.1

orbs:
  win: circleci/windows@5.1.0

jobs:
  build-linux:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            sudo apt update
            sudo apt install -y build-essential cmake gcc clang g++ libssl-dev libboost-all-dev libcurl4-openssl-dev
      
      - run:
          name: Build Project
          command: |
            mkdir -p build
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build --target server -- -j $(nproc)
            
      - run:
          name: Export Executable
          command: |
            mkdir -p ~/export
            cp build/jella ~/export/jella

      - store_artifacts:
          path: ~/export
          destination: artifacts


  build-windows:
    executor: win/server-2022
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            choco install -y cmake
            choco install -y msys2
            set PATH=C:\tools\msys64\usr\bin;%PATH%
            C:\tools\msys64\usr\bin\bash -lc "pacman -Sy --noconfirm mingw-w64-x86_64-toolchain mingw-w64-x86_64-openssl"

      - run:
          name: Build Project
          shell: bash.exe
          command: |
            export PATH=/mingw64/bin:$PATH
            mkdir -p build
            cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DOPENSSL_ROOT_DIR=/mingw64
            cmake --build build --target server

      - run:
          name: Export Executable
          shell: bash.exe
          command: |
            mkdir -p export
            cp build/jella.exe export/jella.exe

      - store_artifacts:
          path: export
          destination: artifacts

workflows:
  build:
    jobs:
      - build-linux
      - build-windows